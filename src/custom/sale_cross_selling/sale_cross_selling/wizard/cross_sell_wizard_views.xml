<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario del wizard de cross-selling -->
    <record id="cross_sell_wizard_form_view" model="ir.ui.view">
        <field name="name">cross.sell.wizard.form</field>
        <field name="model">cross.sell.wizard</field>
        <field name="arch" type="xml">
            <form string="Productos Complementarios Sugeridos">
                <group>
                    <group>
                        <field name="sale_order_id" readonly="1"/>
                    </group>
                    <group>
                        <field name="selected_count" readonly="1"/>
                    </group>
                </group>
                <group string="Productos Sugeridos">
                    <p class="text-muted">
                        <i class="fa fa-lightbulb-o"/>
                        Basándose en los productos de su pedido, le sugerimos los siguientes
                        productos complementarios. Seleccione los que desea añadir.
                    </p>
                </group>
                <field name="line_ids" mode="tree">
                    <tree string="Productos Sugeridos" editable="bottom"
                          decoration-success="selected == True">
                        <field name="selected" widget="boolean_toggle"/>
                        <field name="product_image" widget="image" 
                               options="{'size': [48, 48]}" 
                               class="oe_avatar"/>
                        <field name="product_tmpl_id" readonly="1"/>
                        <field name="product_default_code" readonly="1" optional="show"/>
                        <field name="quantity"/>
                        <field name="product_list_price" readonly="1" widget="monetary"/>
                        <field name="currency_id" column_invisible="1"/>
                    </tree>
                </field>
                <footer>
                    <button name="action_add_selected_products"
                            string="Añadir Seleccionados al Pedido"
                            type="object"
                            class="btn-primary"
                            icon="fa-cart-plus"/>
                    <button name="action_select_all"
                            string="Seleccionar Todos"
                            type="object"
                            class="btn-secondary"
                            icon="fa-check-square-o"/>
                    <button name="action_deselect_all"
                            string="Deseleccionar Todos"
                            type="object"
                            class="btn-secondary"
                            icon="fa-square-o"/>
                    <button string="Cancelar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Extensión del formulario de sale.order para añadir botón de cross-selling -->
    <record id="sale_order_form_view_cross_sell" model="ir.ui.view">
        <field name="name">sale.order.form.cross.sell</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Añadir botón en el header -->
            <xpath expr="//header/button[@name='action_quotation_send']" position="after">
                <button name="action_show_cross_sell_wizard"
                        string="Ver Sugerencias"
                        type="object"
                        class="btn-secondary"
                        icon="fa-lightbulb-o"
                        invisible="state not in ('draft', 'sent')"
                        title="Mostrar productos complementarios sugeridos"/>
            </xpath>
            
            <!-- Campo oculto para saber si hay sugerencias -->
            <field name="partner_id" position="after">
                <field name="has_cross_sell_suggestions" invisible="1"/>
            </field>
        </field>
    </record>

    <!-- Añadir indicador visual en la vista tree de sale.order -->
    <record id="sale_order_tree_view_cross_sell" model="ir.ui.view">
        <field name="name">sale.order.tree.cross.sell</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
            <field name="name" position="after">
                <field name="has_cross_sell_suggestions" column_invisible="1"/>
            </field>
        </field>
    </record>
</odoo>

