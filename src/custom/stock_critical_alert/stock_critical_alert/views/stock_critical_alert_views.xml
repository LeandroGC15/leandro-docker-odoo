<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario de alertas -->
    <record id="stock_critical_alert_view_form" model="ir.ui.view">
        <field name="name">stock.critical.alert.form</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <form string="Alerta de Stock Crítico">
                <header>
                    <button name="action_resolve" 
                            type="object" 
                            string="Resolver" 
                            class="btn-primary"
                            invisible="state != 'open'"/>
                    <button name="action_cancel" 
                            type="object" 
                            string="Cancelar"
                            invisible="state != 'open'"/>
                    <button name="action_reopen" 
                            type="object" 
                            string="Reabrir"
                            invisible="state == 'open'"/>
                    <field name="state" widget="statusbar" statusbar_visible="open,resolved"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" 
                                type="object"
                                name="action_view_product" 
                                icon="fa-cube"
                                invisible="not product_tmpl_id">
                            <span class="o_stat_text">Ver Producto</span>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="display_name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Información del Producto">
                            <field name="product_tmpl_id" readonly="state != 'open'"/>
                            <field name="category_id"/>
                        </group>
                        <group string="Información de Stock">
                            <field name="stock_minimum"/>
                            <field name="qty_available_at_alert"/>
                            <field name="current_qty_available"/>
                            <field name="deficit" 
                                   decoration-danger="deficit > 0"
                                   decoration-success="deficit &lt;= 0"/>
                        </group>
                    </group>
                    <group string="Resolución" invisible="state == 'open'">
                        <field name="resolution_date"/>
                        <field name="resolution_notes"/>
                    </group>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Vista de lista de alertas -->
    <record id="stock_critical_alert_view_tree" model="ir.ui.view">
        <field name="name">stock.critical.alert.tree</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <tree string="Alertas de Stock Crítico" 
                  decoration-danger="state == 'open'"
                  decoration-success="state == 'resolved'"
                  decoration-muted="state == 'cancelled'"
                  default_order="create_date desc">
                <field name="create_date" string="Fecha"/>
                <field name="product_tmpl_id"/>
                <field name="category_id"/>
                <field name="stock_minimum"/>
                <field name="qty_available_at_alert" string="Stock Inicial"/>
                <field name="current_qty_available" string="Stock Actual"/>
                <field name="deficit" decoration-danger="deficit > 0"/>
                <field name="state" widget="badge" 
                       decoration-danger="state == 'open'"
                       decoration-success="state == 'resolved'"
                       decoration-muted="state == 'cancelled'"/>
            </tree>
        </field>
    </record>

    <!-- Vista kanban para dashboard -->
    <record id="stock_critical_alert_view_kanban" model="ir.ui.view">
        <field name="name">stock.critical.alert.kanban</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" 
                    default_group_by="category_id"
                    group_create="false">
                <field name="product_tmpl_id"/>
                <field name="category_id"/>
                <field name="state"/>
                <field name="stock_minimum"/>
                <field name="current_qty_available"/>
                <field name="deficit"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.state.raw_value == 'open' ? 'bg-danger-subtle' : (record.state.raw_value == 'resolved' ? 'bg-success-subtle' : 'bg-secondary-subtle')}">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top mb-2">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="product_tmpl_id"/>
                                        </strong>
                                    </div>
                                    <div class="o_dropdown_kanban dropdown">
                                        <field name="state" widget="label_selection" 
                                               options="{'classes': {'open': 'danger', 'resolved': 'success', 'cancelled': 'secondary'}}"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <span class="text-muted">Stock Actual:</span>
                                            <strong><field name="current_qty_available"/></strong>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">Mínimo:</span>
                                            <strong><field name="stock_minimum"/></strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <span class="text-muted">Déficit:</span>
                                            <strong t-attf-class="#{record.deficit.raw_value > 0 ? 'text-danger' : 'text-success'}">
                                                <field name="deficit"/>
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista pivot para análisis -->
    <record id="stock_critical_alert_view_pivot" model="ir.ui.view">
        <field name="name">stock.critical.alert.pivot</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <pivot string="Análisis de Alertas">
                <field name="category_id" type="row"/>
                <field name="state" type="col"/>
                <field name="deficit" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Vista graph -->
    <record id="stock_critical_alert_view_graph" model="ir.ui.view">
        <field name="name">stock.critical.alert.graph</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <graph string="Alertas por Categoría" type="bar">
                <field name="category_id"/>
                <field name="deficit" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Vista de búsqueda -->
    <record id="stock_critical_alert_view_search" model="ir.ui.view">
        <field name="name">stock.critical.alert.search</field>
        <field name="model">stock.critical.alert</field>
        <field name="arch" type="xml">
            <search string="Buscar Alertas">
                <field name="product_tmpl_id"/>
                <field name="category_id"/>
                <filter string="Abiertas" 
                        name="filter_open" 
                        domain="[('state', '=', 'open')]"/>
                <filter string="Resueltas" 
                        name="filter_resolved" 
                        domain="[('state', '=', 'resolved')]"/>
                <filter string="Canceladas" 
                        name="filter_cancelled" 
                        domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                <filter string="Hoy" 
                        name="filter_today" 
                        domain="[('create_date', '>=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Esta Semana" 
                        name="filter_week" 
                        domain="[('create_date', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Categoría" 
                            name="group_category" 
                            context="{'group_by': 'category_id'}"/>
                    <filter string="Estado" 
                            name="group_state" 
                            context="{'group_by': 'state'}"/>
                    <filter string="Producto" 
                            name="group_product" 
                            context="{'group_by': 'product_tmpl_id'}"/>
                    <filter string="Fecha de Creación" 
                            name="group_date" 
                            context="{'group_by': 'create_date:day'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción para ver todas las alertas -->
    <record id="action_stock_critical_alert" model="ir.actions.act_window">
        <field name="name">Alertas de Stock Crítico</field>
        <field name="res_model">stock.critical.alert</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="search_view_id" ref="stock_critical_alert_view_search"/>
        <field name="context">{
            'search_default_filter_open': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡No hay alertas de stock crítico!
            </p>
            <p>
                Las alertas se generan automáticamente cuando el stock de un producto 
                cae por debajo del umbral mínimo configurado.
            </p>
        </field>
    </record>

    <!-- Acción para dashboard de productos críticos (agrupados por categoría) -->
    <record id="action_stock_critical_alert_dashboard" model="ir.actions.act_window">
        <field name="name">Dashboard: Stock Crítico</field>
        <field name="res_model">stock.critical.alert</field>
        <field name="view_mode">kanban,tree,pivot,graph</field>
        <field name="view_id" ref="stock_critical_alert_view_kanban"/>
        <field name="search_view_id" ref="stock_critical_alert_view_search"/>
        <field name="domain">[('state', '=', 'open')]</field>
        <field name="context">{
            'search_default_group_category': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Excelente! No hay productos en estado crítico
            </p>
            <p>
                Aquí se muestran los productos cuyo stock está por debajo del mínimo,
                agrupados por categoría para facilitar la gestión.
            </p>
        </field>
    </record>

    <!-- Menús -->
    <!-- Sub-menú dentro de Configuración de Inventario -->
    <menuitem id="menu_stock_alert_root"
              name="Alertas de Stock"
              parent="stock.menu_stock_config_settings"
              sequence="99"/>

    <!-- Dashboard en el menú principal de Operaciones -->
    <menuitem id="menu_stock_critical_alert_dashboard"
              name="Dashboard Stock Crítico"
              parent="stock.menu_stock_warehouse_mgmt"
              action="action_stock_critical_alert_dashboard"
              sequence="5"/>

    <!-- Lista de alertas dentro del sub-menú -->
    <menuitem id="menu_stock_critical_alert_list"
              name="Todas las Alertas"
              parent="menu_stock_alert_root"
              action="action_stock_critical_alert"
              sequence="10"/>

    <!-- Productos críticos dentro del sub-menú -->
    <menuitem id="menu_product_stock_critical"
              name="Productos con Stock Crítico"
              parent="menu_stock_alert_root"
              action="action_product_stock_critical"
              sequence="20"/>
</odoo>

